# Kong Gateway + Zitadel SSO E2E Tests
# 
# This workflow runs end-to-end tests for the Kong-Zitadel integration
# on schedule, on PRs affecting the test files, or manually.

name: Kong Zitadel E2E Tests

on:
  # Run on PRs affecting test files or Kong configuration
  pull_request:
    paths:
      - 'tests/e2e/**'
      - 'infrastructure/kong/**'
      - 'playwright.config.ts'
      - '.github/workflows/kong-zitadel-e2e.yml'
  
  # Run on schedule (daily at 6 AM UTC)
  schedule:
    - cron: '0 6 * * *'
  
  # Manual trigger with options
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - staging
          - dev
      browsers:
        description: 'Browsers to test'
        required: true
        default: 'chromium'
        type: choice
        options:
          - chromium
          - firefox
          - webkit
          - all
      debug:
        description: 'Enable debug mode'
        required: false
        default: false
        type: boolean

env:
  CI: true
  NODE_VERSION: '20'

jobs:
  # =============================================================================
  # Job 1: Setup and Install
  # =============================================================================
  setup:
    name: Setup Test Environment
    runs-on: ubuntu-latest
    outputs:
      test_env: ${{ steps.set-env.outputs.environment }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=prod" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ github.event.inputs.browsers || 'chromium' }}

  # =============================================================================
  # Job 2: Run E2E Tests
  # =============================================================================
  test:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    needs: setup
    environment: ${{ needs.setup.outputs.test_env }}
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      matrix:
        browser: 
          - ${{ github.event.inputs.browsers == 'all' && 'chromium' || github.event.inputs.browsers || 'chromium' }}
          - ${{ github.event.inputs.browsers == 'all' && 'firefox' || '' }}
          - ${{ github.event.inputs.browsers == 'all' && 'webkit' || '' }}
        exclude:
          - browser: ''
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      # Azure authentication for Key Vault access
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Fetch secrets from Azure Key Vault
      - name: Get secrets from Key Vault
        id: keyvault
        uses: Azure/get-keyvault-secrets@v1
        with:
          keyvault: kv-kombify-prod
          secrets: >
            kong-url,
            zitadel-issuer,
            zitadel-client-id,
            zitadel-client-secret,
            kombisphere-url,
            redis-host,
            redis-password,
            testmail-namespace,
            testmail-api-key

      - name: Create .env file
        run: |
          cat > .env << EOF
          KONG_URL=${{ steps.keyvault.outputs.kong-url }}
          ZITADEL_ISSUER=${{ steps.keyvault.outputs.zitadel-issuer }}
          ZITADEL_CLIENT_ID=${{ steps.keyvault.outputs.zitadel-client-id }}
          ZITADEL_CLIENT_SECRET=${{ steps.keyvault.outputs.zitadel-client-secret }}
          KOMBISPHERE_URL=${{ steps.keyvault.outputs.kombisphere-url }}
          REDIS_HOST=${{ steps.keyvault.outputs.redis-host }}
          REDIS_PASSWORD=${{ steps.keyvault.outputs.redis-password }}
          TESTMAIL_NAMESPACE=${{ steps.keyvault.outputs.testmail-namespace }}
          TESTMAIL_API_KEY=${{ steps.keyvault.outputs.testmail-api-key }}
          CI=true
          EOF

      - name: Verify Kong health
        id: kong-health
        run: |
          echo "Checking Kong health..."
          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.keyvault.outputs.kong-url }}/health || echo "000")
          echo "Kong health status: $HEALTH_STATUS"
          if [ "$HEALTH_STATUS" != "200" ]; then
            echo "::warning::Kong health check failed with status $HEALTH_STATUS"
          fi
          echo "status=$HEALTH_STATUS" >> $GITHUB_OUTPUT

      - name: Run Playwright tests
        id: playwright
        run: |
          npx playwright test tests/e2e/kong-zitadel-flow.spec.ts \
            --project=${{ matrix.browser }} \
            --reporter=html,json,list \
            --output=test-results/${{ matrix.browser }}
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.browser }}
          path: |
            playwright-report/
            test-results/
          retention-days: 30

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-failures-${{ matrix.browser }}
          path: |
            test-results/**/*.png
            test-results/**/*.webm
            test-results/**/*.zip
          retention-days: 7

      - name: Comment PR with test results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'test-results/results.json';
            
            let summary = '### ðŸ§ª Kong Zitadel E2E Test Results\n\n';
            summary += `**Browser:** ${{ matrix.browser }}\n`;
            summary += `**Environment:** ${{ needs.setup.outputs.test_env }}\n\n`;
            
            if (fs.existsSync(path)) {
              const results = JSON.parse(fs.readFileSync(path, 'utf8'));
              const passed = results.stats?.expected || 0;
              const failed = results.stats?.unexpected || 0;
              const skipped = results.stats?.skipped || 0;
              
              summary += '| Status | Count |\n';
              summary += '|--------|-------|\n';
              summary += `| âœ… Passed | ${passed} |\n`;
              summary += `| âŒ Failed | ${failed} |\n`;
              summary += `| â­ï¸ Skipped | ${skipped} |\n\n`;
              
              if (failed > 0) {
                summary += '#### Failed Tests:\n';
                results.suites?.forEach(suite => {
                  suite.specs?.forEach(spec => {
                    if (spec.ok === false) {
                      summary += `- âŒ ${spec.title}\n`;
                    }
                  });
                });
              }
            } else {
              summary += 'âš ï¸ Test results not available\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  # =============================================================================
  # Job 3: Generate Summary Report
  # =============================================================================
  report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [setup, test]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
          pattern: playwright-report-*

      - name: Generate summary
        run: |
          echo "## Kong Zitadel E2E Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Browser | Status | Report |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          
          for dir in all-artifacts/playwright-report-*/; do
            browser=$(basename "$dir" | sed 's/playwright-report-//')
            echo "| $browser | Completed | [View](artifact) |" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment" >> $GITHUB_STEP_SUMMARY
          echo "- **Target:** ${{ needs.setup.outputs.test_env }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Job 4: Notify on Failure
  # =============================================================================
  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: test
    if: failure() && github.event_name == 'schedule'
    steps:
      - name: Send notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ðŸš¨ Kong Zitadel E2E Tests Failed!
            
            Environment: ${{ needs.setup.outputs.test_env }}
            Commit: ${{ github.sha }}
            Branch: ${{ github.ref }}
            
            Check the workflow run for details.
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
