---
title: Architecture Overview
description: How kombify components work together to manage your infrastructure
sidebarTitle: Architecture
---

kombify is a suite of tools that work together to simplify infrastructure management through a **spec-driven approach**. This page explains how the components interact.

## System Overview

```mermaid
graph TB
    subgraph User["User Layer"]
        YAML["kombination.yaml"]
        UI["Web Dashboard"]
        CLI["CLI Tools"]
    end

    subgraph Cloud["kombify Cloud (Optional SaaS)"]
        direction LR
        Auth["Zitadel SSO"]
        Billing["Stripe Billing"]
        Launcher["Tool Launcher"]
    end

    subgraph Stack["kombify Stack (Core)"]
        direction TB
        API["REST API<br/>Port 5260"]
        gRPC["gRPC Server<br/>Port 5263"]
        Unifier["Unifier Engine"]
        ToFu["OpenTofu Runner"]
        PB["PocketBase<br/>(State)"]
        
        API --> Unifier
        Unifier --> ToFu
        API --> PB
        gRPC --> PB
    end

    subgraph Sim["kombify Sim"]
        SimAPI["REST API<br/>Port 5270"]
        SimUI["Web UI<br/>Port 5271"]
        Docker["Docker Engine"]
        
        SimUI --> SimAPI
        SimAPI --> Docker
    end

    subgraph StackKits["StackKits"]
        CUE["CUE Schemas"]
        Base["base-homelab"]
        HA["ha-homelab"]
        Modern["modern-homelab"]
    end

    subgraph Infra["Your Infrastructure"]
        Agent1["Agent 1<br/>(proxmox-01)"]
        Agent2["Agent 2<br/>(docker-01)"]
        Agent3["Agent 3<br/>(k8s-01)"]
    end

    User --> Cloud
    User --> Stack
    Cloud --> Stack
    
    Stack --> StackKits
    Sim --> StackKits
    
    gRPC <--> Agent1 & Agent2 & Agent3
    ToFu --> Infra

    style User fill:#1e293b,stroke:#4ade80,color:#f8fafc
    style Cloud fill:#1e293b,stroke:#4ade80,color:#f8fafc
    style Stack fill:#1e293b,stroke:#4ade80,color:#f8fafc
    style Sim fill:#1e293b,stroke:#4ade80,color:#f8fafc
    style StackKits fill:#1e293b,stroke:#4ade80,color:#f8fafc
    style Infra fill:#1e293b,stroke:#4ade80,color:#f8fafc
```

## Core Components

### kombify Stack

The orchestration engine that manages your infrastructure.

```mermaid
graph LR
    subgraph Input
        YAML["kombination.yaml"]
    end

    subgraph Stack["kombify Stack"]
        direction TB
        Parse["Parse YAML"]
        Validate["CUE Validation"]
        Resolve["Resolve Dependencies"]
        Generate["Generate OpenTofu"]
        Apply["Apply to Infra"]
        
        Parse --> Validate --> Resolve --> Generate --> Apply
    end

    subgraph Output
        TF["main.tf"]
        Vars["tfvars.json"]
        State["State DB"]
    end

    YAML --> Parse
    Generate --> TF & Vars
    Apply --> State

    style Input fill:#1e293b,stroke:#38bdf8,color:#f8fafc
    style Stack fill:#1e293b,stroke:#fbbf24,color:#f8fafc
    style Output fill:#1e293b,stroke:#4ade80,color:#f8fafc
```

**Tech Stack:**
| Component | Technology | Purpose |
|-----------|------------|---------|
| Backend | Go 1.24+ | Core services and agents |
| Frontend | SvelteKit 2.x | Reactive dashboard UI |
| Database | PocketBase (SQLite) | Embedded state management |
| IaC Engine | OpenTofu 1.6+ | Infrastructure provisioning |
| Validation | CUE 0.15+ | Type-safe configuration |
| Networking | gRPC + mTLS | Secure agent communication |

**Service Ports:**
| Service | Port | Protocol | Description |
|---------|------|----------|-------------|
| Core API | 5260 | HTTP | REST API + PocketBase Admin |
| Frontend | 5261 | HTTP | SvelteKit Dashboard |
| gRPC | 5263 | gRPC/mTLS | Agent communication |

### kombify Sim

The simulation engine for testing before deployment.

```mermaid
graph LR
    subgraph Request
        User["User Request"]
    end

    subgraph Sim["kombify Sim"]
        direction TB
        API["REST API"]
        Engine["Node Engine"]
        Docker["Docker Backend"]
        
        API --> Engine --> Docker
    end

    subgraph Containers
        C1["Container 1<br/>SSH: 2222"]
        C2["Container 2<br/>SSH: 2223"]
        C3["Container 3<br/>SSH: 2224"]
    end

    User --> API
    Docker --> C1 & C2 & C3

    style Request fill:#1e293b,stroke:#38bdf8,color:#f8fafc
    style Sim fill:#1e293b,stroke:#4ade80,color:#f8fafc
    style Containers fill:#1e293b,stroke:#94a3b8,color:#f8fafc
```

**Service Ports:**
| Service | Port | Protocol | Description |
|---------|------|----------|-------------|
| Backend API | 5270 | HTTP | REST API |
| Frontend | 5271 | HTTP | SvelteKit Dashboard |
| SSH (Nodes) | 2222-2322 | SSH | Container SSH access |

### kombify StackKits

Pre-validated infrastructure blueprints.

```mermaid
graph TB
    subgraph Layer3["Layer 3: StackKits"]
        Base["base-homelab<br/><i>Single-node Docker</i>"]
        HA["ha-homelab<br/><i>High availability</i>"]
        Modern["modern-homelab<br/><i>Multi-node Kubernetes</i>"]
    end

    subgraph Layer2["Layer 2: Platforms"]
        Docker["docker/<br/><i>Docker + Traefik</i>"]
        K8s["kubernetes/<br/><i>K3s + Ingress</i>"]
    end

    subgraph Layer1["Layer 1: Core"]
        Bootstrap["Bootstrap"]
        Security["Security"]
        Network["Network"]
        Observe["Observability"]
    end

    Base --> Docker
    HA --> Docker
    Modern --> K8s
    Docker --> Layer1
    K8s --> Layer1

    style Layer3 fill:#1e293b,stroke:#f472b6,color:#f8fafc
    style Layer2 fill:#1e293b,stroke:#38bdf8,color:#f8fafc
    style Layer1 fill:#1e293b,stroke:#4ade80,color:#f8fafc
```

### kombify Cloud

The managed SaaS platform (optional).

```mermaid
graph TB
    subgraph Users
        User1["User"]
        User2["Team"]
    end

    subgraph Cloud["kombify Cloud"]
        direction TB
        Frontend["SvelteKit App"]
        
        subgraph Services
            Auth["Zitadel<br/>(SSO)"]
            DB["PostgreSQL"]
            Pay["Stripe<br/>(Billing)"]
        end
        
        Frontend --> Auth & DB & Pay
    end

    subgraph Tools["Self-Hosted Tools"]
        Stack["kombify Stack"]
        Sim["kombify Sim"]
    end

    Users --> Frontend
    Auth --> Stack & Sim

    style Users fill:#1e293b,stroke:#38bdf8,color:#f8fafc
    style Cloud fill:#1e293b,stroke:#38bdf8,color:#f8fafc
    style Tools fill:#1e293b,stroke:#fbbf24,color:#f8fafc
```

## Data Flow

### Deployment Pipeline

```mermaid
sequenceDiagram
    participant User
    participant Stack as kombify Stack
    participant CUE as CUE Schemas
    participant ToFu as OpenTofu
    participant Agent as Node Agent
    participant Infra as Infrastructure

    User->>Stack: Upload kombination.yaml
    Stack->>CUE: Validate configuration
    CUE-->>Stack: Validation result
    
    alt Validation Failed
        Stack-->>User: Error details
    else Validation Passed
        Stack->>ToFu: Generate HCL
        ToFu-->>Stack: main.tf + tfvars.json
        
        User->>Stack: Apply deployment
        Stack->>ToFu: tofu plan
        ToFu-->>Stack: Execution plan
        
        Stack->>ToFu: tofu apply
        ToFu->>Agent: Configure node
        Agent->>Infra: Provision resources
        Infra-->>Agent: Success
        Agent-->>Stack: Status update
        Stack-->>User: Deployment complete
    end
```

### Simulation Flow

```mermaid
sequenceDiagram
    participant User
    participant Sim as kombify Sim
    participant Docker
    participant Container

    User->>Sim: Create simulation
    Sim->>Docker: Create network
    Docker-->>Sim: Network ready
    
    User->>Sim: Add nodes
    loop For each node
        Sim->>Docker: Pull image
        Sim->>Docker: Create container
        Docker->>Container: Start with SSH
        Container-->>Sim: Container ready
    end
    
    Sim-->>User: Simulation running
    
    User->>Container: SSH connect (port 2222+)
    Container-->>User: Shell access
```

## Security Model

### Agent Communication

```mermaid
graph LR
    subgraph Stack["kombify Stack"]
        gRPC["gRPC Server<br/>Port 5263"]
        CA["Certificate Authority"]
    end

    subgraph Agent["Node Agent"]
        Client["gRPC Client"]
        Cert["Client Certificate"]
    end

    CA -->|Issues| Cert
    Client <-->|mTLS| gRPC

    style Stack fill:#1e293b,stroke:#fbbf24,color:#f8fafc
    style Agent fill:#1e293b,stroke:#4ade80,color:#f8fafc
```

All agent communication uses **mutual TLS (mTLS)**:

1. **Certificate Authority**: Stack Core generates a CA during initialization
2. **Agent Certificates**: Each agent receives a unique certificate signed by the CA
3. **Mutual Authentication**: Both sides verify certificates before communication
4. **Encrypted Channel**: All data is encrypted in transit

### Authentication Flow (Cloud)

```mermaid
sequenceDiagram
    participant User
    participant Cloud as kombify Cloud
    participant Zitadel
    participant Stack as kombify Stack

    User->>Cloud: Access dashboard
    Cloud->>Zitadel: Redirect to login
    User->>Zitadel: Authenticate
    Zitadel-->>Cloud: ID Token + Access Token
    
    User->>Cloud: Launch Stack
    Cloud->>Stack: Forward request + Token
    Stack->>Zitadel: Validate token
    Zitadel-->>Stack: Token valid
    Stack-->>User: Access granted
```

## Deployment Models

<Columns cols={2}>
  <Card title="Self-Hosted (Stack Only)" icon="server">
    Run kombify Stack on your own infrastructure. Full control, no external dependencies.
    
    **Best for:** Privacy-focused users, air-gapped environments
    
    ```bash
    docker compose up -d
    ```
  </Card>
  <Card title="Hybrid (Stack + Cloud)" icon="cloud">
    Use kombify Cloud for SSO and billing while self-hosting Stack.
    
    **Best for:** Teams, enterprise users
    
    Connect via Cloud dashboard
  </Card>
</Columns>

## Next Steps

<Columns cols={3}>
  <Card title="Spec-Driven Concepts" icon="file-code" href="/concepts/spec-driven">
    Learn how kombify transforms YAML into infrastructure
  </Card>
  <Card title="StackKits Deep Dive" icon="boxes-stacked" href="/concepts/stackkits">
    Understand how StackKits provide validated blueprints
  </Card>
  <Card title="Security Model" icon="shield" href="/guides/self-hosting/security">
    Learn about authentication and encryption
  </Card>
</Columns>
